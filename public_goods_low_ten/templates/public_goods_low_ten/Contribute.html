{% extends "global/Base.html" %}
{% load staticfiles otree_tags %}

{% block title %}
  Round <span class="session-round-number">{{ subsession.round_number }}</span> of {{ Constants.num_rounds }}
{% endblock %}

{% block content %}

    <!-- Hidden session code and round number for JavaScript access -->
    <span id="session-code" style="display:none;">{{ session.code }}</span>
    <span id="round-number" style="display:none;">{{ subsession.round_number }}</span>

    {% formfield player.contribution label="How much will you invest to the group account (from 0 to 10)?" %}

    <!-- Hidden field to store calculator data for this page/round -->
    <input type="hidden" name="calc_contribute" id="id_calc_contribute" value="">
    <script>
    $(document).ready(function() {
        var participantCode = window.location.pathname.split('/')[2];
        var sessionCode = $('#session-code').text();
        var roundNum = parseInt($('#round-number').text(), 10);
        // Match the key format from calculator: calc_contribu (8 chars of "Contribute")
        var pageKey = 'calc_contribu_r' + roundNum + '_' + sessionCode + '_' + participantCode;

        console.log('[Contribute Page R' + roundNum + '] Looking for key:', pageKey);

        // Update hidden field before form submission
        $('form').on('submit', function() {
            var logs = localStorage.getItem(pageKey) || '[]';
            $('#id_calc_contribute').val(logs);
            console.log('[Contribute R' + roundNum + '] Saving', JSON.parse(logs).length, 'calculator entries');
            console.log('[Contribute R' + roundNum + '] Data:', logs.substring(0, 200));
        });
    });
    </script>

    <h4>Round history</h4>
    <div style="overflow-x: auto; width: 100%;">
        <table class="table" style="min-width: 800px;">
            <thead>
                <tr>
                    <th>Round</th>
                    <th>Your investment</th>
                    <th colspan="9" style="text-align: center; border-bottom: 2px solid #ddd;">Other members' investments</th>
                    <th>Group account earnings</th>
                    <th>Total earnings</th>
                </tr>
                <tr>
                    <th></th>
                    <th></th>
                    <th>M1</th>
                    <th>M2</th>
                    <th>M3</th>
                    <th>M4</th>
                    <th>M5</th>
                    <th>M6</th>
                    <th>M7</th>
                    <th>M8</th>
                    <th>M9</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for p in player_in_previous_rounds %}
                    <tr>
                        <td><strong>{{ p.subsession.round_number }}</strong></td>
                        <td><strong>{{ p.contribution }}</strong></td>
                        {% for q in p.get_others_in_group %}
                            <td>{{ q.contribution }}</td>
                        {% endfor %}
                        {% for i in "123456789" %}
                            {% if forloop.counter > p.get_others_in_group|length %}
                                <td>-</td>
                            {% endif %}
                        {% endfor %}
                        <td>{{ p.group.individual_share }}</td>
                        <td><strong>{{ p.payoff_each_round }}</strong></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <p></p>


    {% next_button %}

    {% include 'public_goods_low_ten/Instructions.html' %}

{% endblock %}
