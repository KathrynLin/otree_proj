<!-- Calculator Data Logger - Saves localStorage to hidden field on form submit -->
<script>
$(document).ready(function() {
    // Add hidden field if it doesn't exist
    if ($('#id_calculator_usage_log').length === 0) {
        $('form').append('<input type="hidden" name="calculator_usage_log" id="id_calculator_usage_log">');
    }

    // Auto-populate before form submission
    $('form').submit(function() {
        // Get participant code from URL
        var participantCode = window.location.pathname.split('/')[2];

        // Determine which page-specific key to use based on current page
        var pageKey = 'calculator_logs_' + participantCode; // default for most pages
        if (window.location.href.includes('Instructions_quiz') || window.location.href.includes('/quiz/')) {
            pageKey = 'calculator_logs_instructions_quiz_' + participantCode;
        }

        var logs = localStorage.getItem(pageKey) || '[]';
        $('#id_calculator_usage_log').val(logs);
        var count = JSON.parse(logs).length;
        console.log('[Calculator] Saving ' + count + ' submissions from key: ' + pageKey);

        // DO NOT clear localStorage - each participant has their own key, so no conflicts
        // This allows us to preserve data from previous pages
    });
});
</script>
