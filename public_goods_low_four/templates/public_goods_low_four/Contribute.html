{% extends "global/Base.html" %}
{% load staticfiles otree_tags %}

{% block title %}
    Round <span class="session-round-number">{{ subsession.round_number }}</span> of {{ Constants.num_rounds }}
{% endblock %}

{% block content %}

    <!-- Hidden session code and round number for JavaScript access -->
    <span id="session-code" style="display:none;">{{ session.code }}</span>
    <span id="round-number" style="display:none;">{{ subsession.round_number }}</span>

    {% formfield player.contribution label="How much will you invest to the group account (from 0 to 10)?" %}

    <!-- Hidden field to store calculator data for this page/round -->
    <input type="hidden" name="calc_contribute" id="id_calc_contribute" value="">
    <script>
    $(document).ready(function() {
        var participantCode = window.location.pathname.split('/')[2];
        var sessionCode = $('#session-code').text();
        var roundNum = parseInt($('#round-number').text(), 10);
        // Match the key format from calculator: calc_contribu (8 chars of "Contribute")
        var pageKey = 'calc_contribu_r' + roundNum + '_' + sessionCode + '_' + participantCode;

        console.log('[Contribute Page R' + roundNum + '] Looking for key:', pageKey);

        // Update hidden field before form submission
        $('form').on('submit', function() {
            var logs = localStorage.getItem(pageKey) || '[]';
            $('#id_calc_contribute').val(logs);
            console.log('[Contribute R' + roundNum + '] Saving', JSON.parse(logs).length, 'calculator entries');
            console.log('[Contribute R' + roundNum + '] Data:', logs.substring(0, 200));
        });
    });
    </script>

    <h4>Round history</h4>
    <table class="table">
        <tr>
            <th>Round</th>
            <th>Your investment</th>
            <th>Member1's investment</th>
            <th>Member2's investment</th>
            <th>Member3's investment</th>
            <th>Your earnings from the group account</th>
            <th>Your total earnings</th>
        </tr>
        {% for p in player_in_previous_rounds %}
            <tr>
                <td>{{ p.subsession.round_number }}</td>
                <td>{{ p.contribution }}</td>
                {% for q in p.get_others_in_group %}
                <td>{{ q.contribution }}</td>
                {% endfor %}
                <td>{{ p.group.individual_share }}
                <td>{{ p.payoff_each_round }}</td>
            </tr>
        {% endfor %}
    </table>
    <p></p>


    {% next_button %}

    {% include 'public_goods_low_four/Instructions.html' %}

{% endblock %}
